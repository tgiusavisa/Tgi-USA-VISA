{% extends "base.html" %}
{% block content %}
<style>
  .main-header{
    background-color:black !important;
  }
</style>
<div class='container text-center p-3 p-md-5'>
    <h1 class='fw-bolder fs-1 main-heading w-100 text-center'>Fill in your details</h1>
    <p class="text-break w-100 text-center">Pleae Enter Your Details and Book Your Visa Appointment within 5 Weeks</p>
</div>
<div class='container'>
    <div class='row row1-mobile'>
        <div class='col-sm'>    
            <form method="POST" action="{% url 'process_appointment' %}" id="appointmentForm">
                {% csrf_token %}
                    <input type="hidden" name="visa_type" value="{{ visa_type }}">
                    <input type="hidden" name="appointment_location" value="{{ appointment_location }}">
                    <input type="hidden" name="travellers" value="{{ travellers }}">
                <div class="row mt-5">
                    <div class="col-md-12">
                      <label>Full Name</label>
                      <div class="input-group mb-3">
                          <span class="input-group-text form-img form-sec-01 pt-2 pb-2"
                              style="border-radius: 12px 0 0 12px; border: 1.2px solid rgba(0, 0, 0, 0.5); border-right: none !important">
                              <img src="/static/images/icons/account.svg" alt="Full Name" />
                          </span>
                          <input type="text" name="full_name" class="form-control form-sec-01 fs-5" style="border-radius: 0 12px 12px 0; border: 1.2px solid rgba(0, 0, 0, 0.5); border-left: none !important" placeholder="Full Name" required>
                      </div>
                    </div>
                    <div class="col-md-12">
                      <label>Mobile Number</label>
                      <div class="input-group mb-3">
                          <span class="input-group-text form-img form-sec-01 pt-2 pb-2"
                              style="border-radius: 12px 0 0 12px; border: 1.2px solid rgba(0, 0, 0, 0.5); border-right: none !important">
                              <img src="/static/images/icons/call.svg" alt="Phone Number" />
                          </span>
                          <input type="tel" name="mobile_number" class="form-control form-sec-01 fs-5"style="border-radius: 0 12px 12px 0; border: 1.2px solid rgba(0, 0, 0, 0.5); border-left: none !important" placeholder="Mobile Number" required>
                      </div>
                    </div>
                
                    <div class="col-md-12">
                      <label>Email</label>
                      <div class="input-group mb-3">
                          <span class="input-group-text form-img form-sec-01 pt-2 pb-2"
                              style="border-radius: 12px 0 0 12px; border: 1.2px solid rgba(0, 0, 0, 0.5); border-right: none !important">
                              <img src="/static/images/icons/email.svg" alt="Email ID" />
                          </span>
                          <input type="email" name="email" class="form-control form-sec-01 fs-5" style="border-radius: 0 12px 12px 0; border: 1.2px solid rgba(0, 0, 0, 0.5); border-left: none !important" placeholder="Email ID" required>
                      </div>
                    </div>
                    <div class="appointment-button w-100 text-center d-flex justify-content-center align-item-center">
                        <button type="submit" id="submitBtn" class='mb-5 mt-3 w-50 text-decoration-none align-items-center justify-content-center d-flex rounded-pill fw-bold pt-2 pb-2 button2 text-dark border-2 fs-5'>Confirm Appointment</button>
                    </div>          
                    <div class='container d-flex justify-content-center align-item-center mt-3 mb-3 appointment-price-main-sec'>
                      <div class='col-md-12'>
                          <p class=' w-25 text-center fw-bolder fs-6 rounded-pill ps-2 pe-2 m-1 text-dark' style='background-color: #FFDD00; padding-bottom:1px !important;'>Price<p>
                          <ul class='m-0 p-0'>
                            <li class='fs-6 d-flex flex-row align-item-center justify-content-between m-1'><span style='font-weight:500;'>Pay Now</span><span id="payNowAmount">{{ pay_now_amount }}/- </span></li>
                            <li class='fs-6 d-flex flex-row align-item-center justify-content-between m-1'><span style='font-weight:500;'>Processing Fees</span><span id="ProcessingFees">{{ processing_fees }}/- </span></li>
                            <li class='fs-6 d-flex flex-row align-item-center justify-content-between m-1'><span style='font-weight:500;'>Express Date</span><span id="ExpressDate">{{ express_date }}/- </span></li>
                            <li class='fs-6 d-flex flex-row align-item-center justify-content-between m-1'><span style='font-weight:500;'>Inteview Training</span><span class='rounded-pill ps-2 pe-2 text-dark' style='background-color: #FFDD00; padding-bottom:1px !important;'>Free</span></li>
                            <li class='fs-6 d-flex flex-row align-item-center justify-content-between m-1'><span style='font-weight:500;'>Document Checklikst</span><span class='rounded-pill ps-2 pe-2 text-dark' style='background-color: #FFDD00; padding-bottom:1px !important;'>Free</span></li>
                            <li class='fs-6 d-flex flex-row align-item-center justify-content-between m-1'><span style='font-weight:500;'>DS160 Form Review & Suggestion</span><span class='rounded-pill ps-2 pe-2 text-dark' style='background-color: #FFDD00; padding-bottom:1px !important;'>Free</span></li>
                            <li class='fs-6 d-flex flex-row align-item-center justify-content-between m-1'><span style='font-weight:500;'>24/7 Assistance</span><span class='rounded-pill ps-2 pe-2 text-dark' style='background-color: #FFDD00; padding-bottom:1px !important;'>Free</span></li>
                            <div class='w-100 d-flex flex-row align-item-center justify-content-center mt-2 mb-2'><div class='line'></div></div>
                            <li class='fs-6 fw-bold d-flex flex-row align-item-center justify-content-between'><span>Pay later</span><span id="payLaterAmount">{{ pay_later_amount }}/- </span></li>
                            <li class='fs-6 fw-bold d-flex flex-row align-item-center justify-content-between'><span>Total Amount</span><span id="totalAmount">{{ total_amount }}/- </span></li>
                            <input type="hidden" name="pay_now_amount" value="{{ pay_now_amount }}">
                            <input type="hidden" name="processing_fees" value="{{ processing_fees }}">
                            <input type="hidden" name="express_date" value="{{ express_date }}">
                            <input type="hidden" name="pay_later_amount" value="{{ pay_later_amount }}">
                            <input type="hidden" name="total_amount" value="{{ total_amount }}">
                            <input type="hidden" name="service" value="{{ service }}">
                          </ul>
                      </div>
                    </div>  
                </div>
            </form>
        </div>
        <div class='col-sm'>
            <div class='row1-mobile-img'>
                <img src="/static/images/airport.gif" class="d-block w-100 rounded-5" alt="..." style>
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('appointmentForm');
    const submitBtn = document.getElementById('submitBtn');
    
    if (form && submitBtn) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
            
            try {
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });
                
                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }
                
                const data = await response.json();
                
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else if (data.errors) {
                    let errorMessage = 'Please fix the following errors:\n';
                    for (const [field, errors] of Object.entries(data.errors)) {
                        errorMessage += `\n${field}: ${errors.join(', ')}`;
                    }
                    alert(errorMessage);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An unexpected error occurred. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Confirm Appointment';
            }
        });
    }
});

@login_required
def submit_payment_proof(request):
    if request.method == 'POST':
        booking_data = request.session.get('booking_data')
        if not booking_data:
            return redirect('home')
        
        payment_form = PaymentProofForm(request.POST, request.FILES)
        if payment_form.is_valid():
            booking = BookingDetail.objects.create(
                user=request.user if request.user.is_authenticated else None,
                **booking_data
            )
            
            payment = payment_form.save(commit=False)
            payment.booking = booking
            payment.save()
            
            send_payment_proof_email(payment, booking)

            # Clear the session data after successful payment
            if 'booking_data' in request.session:
                del request.session['booking_data']
                
            return render(request, 'clients/payment_thankyou.html', {
                'payment': payment,
                'booking': booking
            })
    
    return render(request, 'clients/success.html', {
        'payment_form': PaymentProofForm(),
        'booking_data': request.session.get('booking_data', {})
    })
</script>
<script>
  def process_appointment(request):
    if request.method == 'POST':
        try:
            # Store all data in session
            request.session['booking_data'] = {
                'full_name': request.POST.get('full_name'),
                'mobile_number': request.POST.get('mobile_number'),
                'email': request.POST.get('email'),
                'visa_type': request.POST.get('visa_type'),
                'service': request.POST.get('service'),
                'appointment_location': request.POST.get('appointment_location'),
                'travellers': request.POST.get('travellers'),
                'pay_now_amount': request.POST.get('pay_now_amount'),
                'processing_fees': request.POST.get('processing_fees'),
                'express_date': request.POST.get('express_date'),
                'pay_later_amount': request.POST.get('pay_later_amount'),
                'total_amount': request.POST.get('total_amount'),
            }
            
            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return JsonResponse({
                    'status': 'success',
                    'redirect_url': reverse('success_page')
                })
            return redirect('success_page')
        except Exception as e:
            if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
                return JsonResponse({
                    'status': 'error',
                    'errors': {'__all__': [str(e)]}
                }, status=400)
            messages.error(request, f"Error processing appointment: {str(e)}")
            return redirect('appointment_details')
</script>


{% endblock %}